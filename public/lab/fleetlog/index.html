<!-- /public/lab/fleetlog/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SB FleetLog™ — App</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b0b0b" />
  <script defer src="/scripts/sb-analytics.js"></script>

  <style>
    :root{
      --bg:#0b0b0b;
      --card:#121212;
      --line:#242424;
      --text:#f2f2f2;
      --muted:#b8b8b8;
      --bad:#ef4444;
      --ok:#22c55e;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:20px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    a{color:#fff;text-decoration:none}

    .app{
      width:100%;
      max-width:640px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:26px;
    }

    h1{margin:0 0 8px;font-size:28px}
    .muted{color:var(--muted);font-size:14px;margin:0 0 18px}

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 0}

    input{
      flex:1;
      min-width:240px;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0f0f0f;
      color:var(--text);
      outline:none;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      font-weight:900;
    }

    .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:var(--muted);
      display:inline-block;
    }

    .badge.ok{ color:#bbf7d0; border-color:#12311f; }
    .badge.ok .dot{ background:var(--ok); }

    .badge.bad{ color:#fecaca; border-color:#3a1f1f; }
    .badge.bad .dot{ background:var(--bad); }

    .badge.warn{ color:#fde68a; border-color:#3a2b10; }
    .badge.warn .dot{ background:#f59e0b; }

    .submeta{
      color:var(--muted);
      font-size:12px;
      margin-top:8px;
      word-break:break-word;
    }

    .btn{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--line);
      font-weight:900;
      cursor:pointer;
      text-align:center;
      display:block;
    }

    .btn-primary{background:#fff;color:#000}
    .btn-ghost{background:transparent;color:#fff}
    .btn-danger{background:transparent;color:#fff;border-color:#3a1f1f}

    .status{margin-top:10px;font-size:13px;color:var(--muted)}
    .status.bad{color:var(--bad)}
    .status.ok{color:var(--ok)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.grid2{grid-template-columns:1fr}}

    .gate{margin-top:14px;border-top:1px solid var(--line);padding-top:14px}
    .tag{display:inline-block;margin-top:6px;font-size:12px;color:var(--muted)}
    .hidden{display:none!important}
  </style>
</head>

<body>
  <div class="app">

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div class="pill">SB FleetLog™ App</div>
      <a class="pill" href="/fleetlog/">Marketing</a>
    </div>

    <h1>FleetLog</h1>
    <p class="muted">Enter your email. If your subscription is active, the app unlocks instantly.</p>

    <div class="row">
      <input id="email" type="email" placeholder="driver email" autocomplete="email" />
      <button class="pill" id="checkBtn">Check</button>
    </div>

    <div class="status" id="status"></div>

    <div id="badgeWrap" class="hidden" style="margin-top:10px;">
      <div id="subBadge" class="badge">
        <span class="dot"></span>
        <span id="badgeText">—</span>
      </div>
      <div id="subMeta" class="submeta"></div>
    </div>

    <div id="unlocked" class="hidden" style="margin-top:14px;">
      <div class="grid2">
        <a class="btn btn-primary" href="/lab/fleetlog/new/">Create New Daily Log</a>
        <a class="btn btn-ghost" id="historyLink" href="#">View Log History</a>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <a class="btn btn-ghost" id="billingLink" href="#">Manage Billing</a>
        <a class="btn btn-ghost" id="upgradeLink" href="#">Upgrade to Fleet</a>
      </div>

      <div class="tag" id="planTag"></div>
    </div>

    <div id="gate" class="gate hidden">
      <div class="muted" style="margin-bottom:10px;">
        No active subscription found for this email.
      </div>

      <div class="grid2">
        <a class="btn btn-primary" href="/api/fleetlog/stripe/checkout?tier=single">Subscribe — Single ($19/mo)</a>
        <a class="btn btn-ghost" href="/api/fleetlog/stripe/checkout?tier=fleet">Subscribe — Fleet ($99/mo)</a>
      </div>
    </div>

    <div style="margin-top:12px;">
      <button class="btn btn-danger" id="clearBtn">Clear Email</button>
    </div>

  </div>

<script>
const $ = (id)=>document.getElementById(id);
const KEY = "fleetlog_email";

function getEmail(){ return ($("email").value||"").trim().toLowerCase(); }
function setStatus(msg,kind){
  $("status").textContent = msg||"";
  $("status").className = "status" + (kind?(" "+kind):"");
}
function show(id,on){ $(id).classList.toggle("hidden",!on); }

async function checkStatus(){
  const email = getEmail();
  if(!email.includes("@")){
    setStatus("Enter valid email.","bad");
    return;
  }

  try{
    const r = await fetch(`/api/fleetlog/auth/status?email=${encodeURIComponent(email)}`);
    const j = await r.json();
    if(!j.ok) throw new Error(j.error);

    localStorage.setItem(KEY,email);

    $("historyLink").href = `/lab/fleetlog/history/?email=${encodeURIComponent(email)}`;
    $("billingLink").href = `/api/fleetlog/stripe/portal?email=${encodeURIComponent(email)}`;
    $("upgradeLink").href = `/api/fleetlog/stripe/portal?email=${encodeURIComponent(email)}`;

    show("badgeWrap",true);

    const tier = (j.tier||"").toUpperCase();
    const tierRaw = (j.tier||"").toLowerCase();

    const badge = $("subBadge");
    badge.className="badge";

    if(j.active){
      badge.classList.add("ok");
      $("badgeText").textContent=`ACTIVE • ${tier}`;

      show("unlocked",true);
      show("gate",false);

      // usage count
      let usage="";
      try{
        const ur=await fetch(`/api/fleetlog/logs/list?email=${encodeURIComponent(email)}&limit=1000`);
        const lj=await ur.json();
        if(lj.ok){
          const used=(lj.logs||[]).length;
          const max=(tierRaw==="fleet")?300:30;
          usage=` • Logs Used: ${used}/${max}`;
        }
      }catch{}

      $("planTag").textContent=`ACTIVE • ${tier}${usage}`;
      $("upgradeLink").style.display=(tierRaw==="fleet")?"none":"block";
      setStatus("Subscription active.","ok");

    }else{
      badge.classList.add("bad");
      $("badgeText").textContent="NO SUBSCRIPTION";
      show("unlocked",false);
      show("gate",true);
      $("planTag").textContent="";
      setStatus("No active subscription.","bad");
    }

  }catch(e){
    setStatus(e.message,"bad");
  }
}

$("checkBtn").addEventListener("click",checkStatus);
$("email").addEventListener("keydown",(e)=>{ if(e.key==="Enter")checkStatus(); });

$("clearBtn").addEventListener("click",()=>{
  localStorage.removeItem(KEY);
  $("email").value="";
  show("badgeWrap",false);
  show("unlocked",false);
  show("gate",false);
  setStatus("");
});

const saved=(localStorage.getItem(KEY)||"").trim().toLowerCase();
if(saved){
  $("email").value=saved;
  checkStatus();
}
</script>
</body>
</html>
