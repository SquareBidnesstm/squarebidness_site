<!DOCTYPE html>
<html lang="en">
<head>
  <!-- shared head bits -->
  <link rel="preconnect" href="https://www.googletagmanager.com">
  <link rel="preconnect" href="https://www.google-analytics.com">
  <script defer src="/scripts/ga.js"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Search — Square Bidness</title>
  <link rel="canonical" href="https://www.squarebidness.com/search/" />
  <meta name="description" content="Search Square Bidness products and posts." />
  <meta name="theme-color" content="#000000" />
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="stylesheet" href="/styles/style.css" />

  <!-- JSON-LD: WebSite + SearchAction -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "@id":"https://www.squarebidness.com/#website",
    "url":"https://www.squarebidness.com/",
    "name":"Square Bidness",
    "potentialAction":{
      "@type":"SearchAction",
      "target":"https://www.squarebidness.com/search/?q={search_term_string}",
      "query-input":"required name=search_term_string"
    }
  }
  </script>

  <style>
    .search-wrap{max-width:900px;margin:1.5rem auto;padding:0 16px}
    .search-bar{display:flex;gap:.5rem}
    .search-bar input{flex:1;padding:.7rem .9rem;border-radius:8px;border:1px solid #2a2a2a;background:#0f0f0f;color:#eee}
    .search-bar button{padding:.7rem 1rem;border-radius:8px;border:1px solid #444;background:#c9a227;color:#111;font-weight:700}
    .results{margin-top:1rem;display:grid;gap:.75rem}
    .result{border:1px solid #1f1f1f;border-radius:12px;padding:12px;background:#0e0e0e}
    .result h3{margin:.2rem 0}
    .result small{opacity:.8}
    .pill{display:inline-block;border:1px solid #333;border-radius:999px;padding:.15rem .5rem;font-size:.75rem;margin-right:.35rem;opacity:.9}
    .muted{opacity:.8}
    .site-bottom {margin:2rem auto 3rem;max-width:900px;padding:0 16px;text-align:center;opacity:.8}
    .site-bottom a{color:#c9a227}
  </style>
</head>
<body class="theme-dark">
  <div id="nav-placeholder"></div>

  <main class="search-wrap">
    <h1>Search</h1>
    <form class="search-bar" id="search-form" role="search">
      <input id="search-input" name="q" type="search" placeholder="Search products, posts…" autocomplete="off" />
      <button type="submit">Search</button>
    </form>

    <div id="search-stats" class="muted" style="margin-top:.5rem"></div>
    <section id="search-results" class="results" aria-live="polite"></section>
  </main>

  <div id="footer-placeholder"></div>

  <div class="site-bottom">
    © 2025 Square Bidness Tech Lab — <a href="/linkme/">Link Me</a>
  </div>

  <script>
    // Load site chrome
    document.addEventListener("DOMContentLoaded", async () => {
      try { document.getElementById("nav-placeholder").innerHTML = await (await fetch("/nav/")).text(); } catch {}
      try { document.getElementById("footer-placeholder").innerHTML = await (await fetch("/footer/")).text(); } catch {}
    });

    // ===== DOM =====
    const $form    = document.querySelector('#search-form');
    const $q       = document.querySelector('#search-input');
    const $results = document.querySelector('#search-results');
    const $stats   = document.querySelector('#search-stats');

    // ===== Helpers =====
    const norm  = s => (s||'').toString().toLowerCase();
    const match = (hay, needle) => norm(hay).includes(norm(needle));
    const esc   = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    function pill(txt){ return `<span class="pill">${esc(txt)}</span>`; }
    function money(n){ try { return `$${Number(n).toFixed(2)}` } catch { return '' } }

    // ===== Data loaders =====
    async function loadProducts() {
      try {
        const r = await fetch('/products.json', { cache: 'no-store' });
        if (!r.ok) return {};
        return await r.json(); // { sku: { name, desc, price, url?, path? } }
      } catch { return {}; }
    }

    async function loadBlog() {
      // Fallback minimal inline list in case /blog/index.json is missing
      const FALLBACK = [
        {
          title: "Innovation Fest 2025: From Louisiana to NYC",
          url: "/blog/post/innovation-fest-2025/",
          desc: "Four days in NYC, key takeaways, and what’s next for Square Bidness.",
          date: "2025-09-24"
        }
      ];
      try {
        const r = await fetch('/blog/index.json', { cache: 'no-store' });
        if (!r.ok) return FALLBACK;
        return await r.json(); // [ { title, url, desc, date? } ]
      } catch { return FALLBACK; }
    }

    // ===== Cards =====
    function productCard(p) {
      const url   = p.url || p.path || (p.sku ? `/product-${p.sku.replace(/^sb-?/,'')}.html` : '#');
      const price = (p.price != null) ? money(p.price) : '';
      return `
        <article class="result">
          ${pill('Product')}
          <h3><a href="${esc(url)}">${esc(p.name || p.title || p.sku || 'Product')}</a></h3>
          ${price ? `<div><strong>${esc(price)}</strong></div>` : ``}
          ${p.desc ? `<p class="muted">${esc(p.desc)}</p>` : ``}
          ${p.sku ? `<small class="muted">SKU: ${esc(p.sku)}</small></small>` : ``}
        </article>
      `;
    }

    function postCard(post) {
      return `
        <article class="result">
          ${pill('Post')}
          <h3><a href="${esc(post.url || '#')}">${esc(post.title || 'Post')}</a></h3>
          ${post.desc ? `<p class="muted">${esc(post.desc)}</p>` : ``}
          ${post.date ? `<small class="muted">${new Date(post.date).toLocaleDateString()}</small>` : ``}
        </article>
      `;
    }

    // ===== Search core =====
    async function runSearch(q) {
      const needle = norm(q);
      if (!needle) {
        $results.innerHTML = '';
        $stats.textContent = '';
        return;
      }

      const [productsIdx, blogIdx] = await Promise.all([loadProducts(), loadBlog()]);

      // Products (object -> array)
      const products = Object.keys(productsIdx || {}).map(k => productsIdx[k] || {});
      const productHits = products.filter(p =>
        match(p.name, needle) || match(p.desc, needle) || match(p.sku, needle)
      );

      // Posts
      const postHits = (blogIdx || []).filter(b =>
        match(b.title, needle) || match(b.desc, needle)
      );

      const total = productHits.length + postHits.length;
      $stats.textContent = total ? `${total} result${total===1?'':'s'} for “${q}”` : `No results for “${q}”`;

      if (!total) {
        $results.innerHTML = `<div class="empty"><p>No results. Try “VSOP”, “jacket”, “shorts”, or “innovation”.</p></div>`;
        return;
      }

      const blocks = [];
      if (productHits.length) {
        blocks.push(`
          <h4 class="group-title">Products (${productHits.length})</h4>
          <div class="results-grid">
            ${productHits.map(productCard).join('')}
          </div>
        `);
      }
      if (postHits.length) {
        blocks.push(`
          <h4 class="group-title">Posts (${postHits.length})</h4>
          <div class="results-grid">
            ${postHits.map(postCard).join('')}
          </div>
        `);
      }

      $results.innerHTML = blocks.join('\n');
    }

    // ===== URL param <-> input wiring =====
    function getQueryFromURL() {
      const u = new URL(location.href);
      return u.searchParams.get('q') || '';
    }
    function setQueryInURL(q) {
      const u = new URL(location.href);
      if (q) { u.searchParams.set('q', q); } else { u.searchParams.delete('q'); }
      history.replaceState(null, '', u.toString());
    }

    // Debounce
    let t = null;
    function debouncedSearch(q) {
      clearTimeout(t);
      t = setTimeout(() => runSearch(q), 150);
    }

    // ===== Init =====
    (function init() {
      const q = getQueryFromURL();
      if ($q) $q.value = q;
      if (q) runSearch(q);

      $q?.addEventListener('input', (e) => {
        const v = e.target.value.trim();
        setQueryInURL(v);
        debouncedSearch(v);
      });

      $form?.addEventListener('submit', (e) => {
        e.preventDefault();
        const v = ($q?.value || '').trim();
        setQueryInURL(v);
        runSearch(v);
      });
    })();
  </script>
</body>
</html>
