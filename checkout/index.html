<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Performance -->
  <link rel="preconnect" href="https://www.googletagmanager.com">
  <link rel="preconnect" href="https://www.google-analytics.com">

  <!-- GA4 (site-wide) -->
  <script defer src="/scripts/ga.js"></script>

  <!-- Basics -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout â€” Square Bidness</title>

  <!-- SEO (noindex checkout) -->
  <meta name="description" content="Secure checkout â€” review your order and complete payment." />
  <link rel="canonical" href="https://www.squarebidness.com/checkout/" />
  <meta name="robots" content="noindex,nofollow" />

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Square Bidness">
  <meta property="og:title" content="Checkout â€” Square Bidness">
  <meta property="og:description" content="Secure checkout â€” review your order and complete payment.">
  <meta property="og:url" content="https://www.squarebidness.com/checkout/">
  <meta property="og:image" content="https://www.squarebidness.com/assets/sb-social-card_1200.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Checkout â€” Square Bidness" />
  <meta name="twitter:description" content="Secure checkout â€” review your order and complete payment." />
  <meta name="twitter:image" content="https://www.squarebidness.com/assets/sb-social-card_1200.jpg" />

  <!-- CSS -->
  <link rel="stylesheet" href="/styles/style.css" />

  <!-- Icons / PWA -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="/assets/icons/icon-180.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#000000">

  <!-- Org JSON-LD (site-wide) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Organization",
    "@id":"https://www.squarebidness.com/#org",
    "name":"Square Bidness Apparel",
    "url":"https://www.squarebidness.com/",
    "logo":"https://www.squarebidness.com/assets/cleantextlogo.png",
    "sameAs":[
      "https://instagram.com/squarebidnesstm",
      "https://www.tiktok.com/@squarebidnesstm",
      "https://www.facebook.com/squarebidnessapparel",
      "https://bsky.app/profile/squarebidnesstm.bsky.social",
      "https://www.linkedin.com/company/square-bidness-apparel"
    ],
    "contactPoint":[{ "@type":"ContactPoint", "contactType":"customer support", "email":"squarebidnessapparel@gmail.com", "areaServed":"US" }]
  }
  </script>

  <!-- Global cart helpers -->
  <script src="/scripts/sb-cart.js" defer></script>

  <!-- Stripe.js (for server checkout sessions) -->
  <script src="https://js.stripe.com/v3/"></script>

  <!-- Inject nav/footer -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      try { document.getElementById("nav-placeholder").innerHTML = await (await fetch("/nav/")).text(); } catch {}
      try { document.getElementById("footer-placeholder").innerHTML = await (await fetch("/footer/")).text(); } catch {}
    });
  </script>
</head>

<body class="theme-dark" id="top">
  <!-- NAV -->
  <div id="nav-placeholder"></div>

  <!-- HERO -->
  <header class="page-hero">
    <div class="container">
      <h1 class="page-title">Checkout</h1>
      <p class="page-subtitle">Review your order and complete payment</p>
    </div>
  </header>

  <!-- MAIN -->
  <main class="section">
    <div class="container" style="max-width:900px">
      <!-- Order Items -->
      <div class="order">
        <table class="cart-table">
          <thead>
            <tr>
              <th style="text-align:left;">Item</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Line</th>
            </tr>
          </thead>
          <tbody id="order-items"><!-- JS fills --></tbody>
        </table>
      </div>

      <!-- Summary -->
      <div class="summary" id="order-summary" style="margin-top:1.5rem; display:none;">
        <table>
          <tr><td>Subtotal</td><td class="right" id="order-subtotal">$0.00</td></tr>
          <tr id="order-discount-row" style="display:none">
            <td class="discount-code-label">Discount</td>
            <td class="right" id="order-discount">-$0.00</td>
          </tr>
          <tr><td>Estimated Tax (9.45%)</td><td class="right" id="order-tax">$0.00</td></tr>
          <tr class="total"><td>Total</td><td class="right" id="order-total">$0.00</td></tr>
        </table>

        <div style="display:flex; gap:.5rem; margin-top:1rem; flex-wrap:wrap;">
          <a href="/cart/" class="btn btn--ghost">Back to Cart</a>
          <button id="pay-button" class="btn btn--gold">Pay Securely</button>
        </div>

        <p style="opacity:.8; margin-top:.75rem;">ðŸ”’ Secure checkout powered by Stripe.</p>
      </div>

      <!-- Empty state -->
      <div id="empty" style="text-align:center; padding:2rem; display:none;">
        <p style="opacity:.85">Your cart is empty.</p>
        <a class="btn btn--ghost" href="/shop/">Continue Shopping</a>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <div id="footer-placeholder"></div>

  <!-- Checkout logic -->
  <script>
  (function() {
    // ---- Config ----
    const CART_KEY   = 'sb_cart_v1';
    const COUPON_KEY = 'sb_coupon';
    const TAX_RATE   = 0.0945;
    const CHECKOUT_ENDPOINT = "https://sb-checkout-server.vercel.app/api/create-checkout-session";
    // Optional direct Payment Link short-circuit (pure hat cart)
    const STRIPE_LINKS = { "sb-hoco-hat": "https://buy.stripe.com/7sY9ATaJV529del8Fa8N20h" };

    const moneyFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
    const money = n => moneyFmt.format(Number(n || 0));

    const readCart = () => { try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch { return []; } };
    const getCoupon = () => (localStorage.getItem(COUPON_KEY) || "").trim().toUpperCase();

    function applyCoupon(subtotal) {
      const code = getCoupon();
      if (!code) return { discount: 0, code: null };
      if (code === 'NYC25'  && subtotal >= 200) return { discount: 25, code };
      if (code === 'VSOP25' && subtotal >= 150) return { discount: 25, code };
      return { discount: 0, code };
    }

    function render() {
      const items = readCart().filter(i => Number(i.quantity ?? i.qty ?? 0) > 0);
      const tbody = document.getElementById('order-items');
      const summary = document.getElementById('order-summary');
      const empty   = document.getElementById('empty');
      const subEl   = document.getElementById('order-subtotal');
      const taxEl   = document.getElementById('order-tax');
      const totEl   = document.getElementById('order-total');
      const discRow = document.getElementById('order-discount-row');
      const discEl  = document.getElementById('order-discount');

      if (!items.length) {
        empty.style.display = '';
        summary.style.display = 'none';
        tbody.innerHTML = '';
        return;
      }

      tbody.innerHTML = items.map(i => {
        const q = Number(i.quantity ?? i.qty ?? 1);
        const line = Number(i.price || 0) * q;
        return `
          <tr>
            <td>
              ${i.image ? `<img src="${i.image}" alt="" style="width:54px;height:54px;object-fit:cover;border-radius:6px;vertical-align:middle;margin-right:.5rem">` : ``}
              ${i.name || i.id}
            </td>
            <td>${money(i.price)}</td>
            <td>${q}</td>
            <td>${money(line)}</td>
          </tr>
        `;
      }).join('');

      const subtotal = items.reduce((s,i)=> s + Number(i.price||0) * Number(i.quantity ?? i.qty ?? 1), 0);
      const { discount, code } = applyCoupon(subtotal);
      const taxedBase = Math.max(0, subtotal - discount);
      const tax = taxedBase * TAX_RATE;
      const total = taxedBase + tax;

      subEl.textContent = money(subtotal);
      taxEl.textContent = money(tax);
      totEl.textContent = money(total);

      if (discount > 0) {
        discRow.style.display = '';
        discEl.textContent = `-${money(discount)}`;
        const label = discRow.querySelector('.discount-code-label');
        if (label) label.textContent = `Discount${code ? ` (${code})` : ''}`;
      } else {
        discRow.style.display = 'none';
      }

      summary.style.display = '';
    }

    async function pay() {
      const btn = document.getElementById('pay-button');
      if (!btn) return;

      const items = readCart().map(i => ({
        id: i.id,
        name: i.name,
        price: Number(i.price) || 0,
        qty: Number(i.quantity ?? i.qty ?? 1)
      })).filter(i => i.qty > 0);

      if (!items.length) return alert('Your cart is empty');

      // Short-circuit: direct Payment Link for a pure hat cart
      if (items.length === 1) {
        const link = STRIPE_LINKS[items[0].id || ""];
        if (link) { location.assign(link); return; }
      }

      // GA4 begin_checkout (best effort)
      try {
        if (typeof gtag === 'function') {
          const value = items.reduce((s, i) => s + (i.price * i.qty), 0);
          gtag('event', 'begin_checkout', {
            currency: 'USD',
            value,
            items: items.map(i => ({
              item_id: i.id, item_name: i.name, price: i.price, quantity: i.qty
            }))
          });
        }
      } catch(_) {}

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Processing...';

      try {
        const coupon = getCoupon() || null;

        // snapshot for thank-you page
        const subtotal = items.reduce((s, i) => s + (i.price * i.qty), 0);
        const { discount } = applyCoupon(subtotal);
        const tax = (subtotal - discount) * TAX_RATE;
        const total = subtotal - discount + tax;
        const orderId = 'SB-' + Date.now();
        sessionStorage.setItem('sb_last_order', JSON.stringify({
          orderId, createdAt: Date.now(), items, coupon, subtotal, discount, tax, total, shipping: 0
        }));

        // Create checkout session via server
        const res = await fetch(CHECKOUT_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items, coupon })
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error('Checkout server error:', res.status, txt);
          throw new Error('Checkout server error');
        }

        const data = await res.json();

        if (data.url) { location.assign(data.url); return; }
        if (data.id && data.publishableKey && window.Stripe) {
          const stripe = Stripe(data.publishableKey);
          const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
          if (error) throw error;
          return;
        }

        throw new Error('No checkout URL or sessionId returned');
      } catch (e) {
        console.error(e);
        alert('Checkout failed. Please try again or contact support.');
        btn.disabled = false; 
        btn.textContent = old;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      render();
      document.getElementById('pay-button')?.addEventListener('click', pay);
    });
  })();
  </script>
</body>
</html>
